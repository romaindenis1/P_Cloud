name: Deploy PassionLecture to Azure

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # Install frontend dependencies and build Vue app
      - name: Install frontend dependencies
        working-directory: ./code/frontend
        run: npm install

      - name: Build frontend
        working-directory: ./code/frontend
        run: npm run build

      # Copy Vue build output into backend's public folder
      - name: Copy frontend build into backend public folder
        run: |
          mkdir -p ./code/backend/src/public
          cp -r ./code/frontend/dist/* ./code/backend/src/public/

      # 4.Create a .env for the backend from GitHub secrets
      - name: Create backend .env from secrets
        shell: bash
        run: |
          echo "Creating backend .env from repository secrets..."
          mkdir -p ./code/backend
          # create .env
          cat > ./code/backend/.env <<'EOF'
          COMPOSE_PROJECT_NAME=P_Passion-Lecture
          EOF

          # Database URL
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> ./code/backend/.env
          else
            # if no database URL, brute force secrets
            echo "DB_REMOTE_HOST=${{ secrets.DB_REMOTE_HOST }}" >> ./code/backend/.env
            echo "DB_REMOTE_PORT=${{ secrets.DB_REMOTE_PORT }}" >> ./code/backend/.env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> ./code/backend/.env
            echo "DB_USER=${{ secrets.DB_USER }}" >> ./code/backend/.env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> ./code/backend/.env
          fi

          # MSAL things
          echo "AZURE_AUTH_ENABLED=${{ secrets.AZURE_AUTH_ENABLED }}" >> ./code/backend/.env
          echo "AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> ./code/backend/.env
          echo "AZURE_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> ./code/backend/.env
          echo "AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> ./code/backend/.env
          echo "AZURE_REDIRECT_URI=${{ secrets.AZURE_REDIRECT_URI }}" >> ./code/backend/.env
          echo "POST_LOGOUT_REDIRECT=${{ secrets.POST_LOGOUT_REDIRECT }}" >> ./code/backend/.env

          # Session secret
          echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> ./code/backend/.env

      # Install backend dependencies
      - name: Install backend dependencies
        working-directory: ./code/backend
        run: npm install

      # Deploy backend to Azure App Service
      - name: Deploy app to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: "passion-lecture-romrom"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: "code/backend"
