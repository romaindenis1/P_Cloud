name: Deploy Vue + Express to Azure App Service

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # 3️⃣ Install frontend dependencies and build Vue app
      - name: Install frontend dependencies
        working-directory: ./code/frontend
        run: npm install

      - name: Build frontend
        working-directory: ./code/frontend
        run: npm run build

      # 4️⃣ Copy Vue build output into backend's public folder
      - name: Copy frontend build into backend public folder
        run: |
          mkdir -p ./code/backend/src/public
          cp -r ./code/frontend/dist/* ./code/backend/src/public/

      # 4.5️⃣ Create a .env for the backend from GitHub secrets
      - name: Create backend .env from secrets
        shell: bash
        run: |
          echo "Creating backend .env from repository secrets..."
          mkdir -p ./code/backend
          # start fresh .env
          cat > ./code/backend/.env <<'EOF'
          # Generated by CI - do not commit
          COMPOSE_PROJECT_NAME=P_Web-295-passion-lecture
          EOF

          # Prefer DATABASE_URL if provided
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> ./code/backend/.env
          else
            # fallback to discrete DB secrets (may be empty)
            echo "DB_REMOTE_HOST=${{ secrets.DB_REMOTE_HOST }}" >> ./code/backend/.env
            echo "DB_REMOTE_PORT=${{ secrets.DB_REMOTE_PORT }}" >> ./code/backend/.env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> ./code/backend/.env
            echo "DB_USER=${{ secrets.DB_USER }}" >> ./code/backend/.env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> ./code/backend/.env
          fi

          # MSAL / Azure AD settings (optional)
          # Do NOT write client secrets or tenant IDs into the deployed package.
          # We will set sensitive values as App Settings in Azure instead.
          echo "AZURE_AUTH_ENABLED=${{ secrets.AZURE_AUTH_ENABLED }}" >> ./code/backend/.env
          # Optional non-secret redirect values can be written if provided
          if [ -n "${{ secrets.AZURE_REDIRECT_URI }}" ]; then
            echo "AZURE_REDIRECT_URI=${{ secrets.AZURE_REDIRECT_URI }}" >> ./code/backend/.env
          fi
          if [ -n "${{ secrets.POST_LOGOUT_REDIRECT }}" ]; then
            echo "POST_LOGOUT_REDIRECT=${{ secrets.POST_LOGOUT_REDIRECT }}" >> ./code/backend/.env
          fi

          # Session secret
          echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> ./code/backend/.env

          # Optional SSL CA for MySQL (base64 PEM) - will be consumed by the app if present
          if [ -n "${{ secrets.MYSQL_SSL_CA }}" ]; then
            echo "MYSQL_SSL_CA=${{ secrets.MYSQL_SSL_CA }}" >> ./code/backend/.env
          fi

          echo ".env created (contents masked in logs)"

      # 5️⃣ Install backend dependencies
      - name: Install backend dependencies
        working-directory: ./code/backend
        run: npm install

      # 6️⃣ Configure Azure App Settings (don't store secrets in the package)
      - name: Azure Login (for app settings)
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure App Settings (redirect URIs)
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        shell: bash
        run: |
          echo "Locating resource group for webapp 'passion-lecture-romrom'..."
          RG=$(az webapp list --query "[?name=='passion-lecture-romrom'] | [0].resourceGroup" -o tsv)
          if [ -z "$RG" ]; then
            echo "Could not determine resource group for webapp 'passion-lecture-romrom'" >&2
            exit 1
          fi
          echo "Setting redirect URIs as App Settings..."
          az webapp config appsettings set --resource-group "$RG" --name passion-lecture-romrom --settings \
            AZURE_REDIRECT_URI="${{ secrets.AZURE_REDIRECT_URI }}" \
            POST_LOGOUT_REDIRECT="${{ secrets.POST_LOGOUT_REDIRECT }}" \
            AZURE_CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}" \
            AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}"
          echo "App Settings updated. Do not store client secrets in files; set AZURE_CLIENT_SECRET as a secret in the portal or Key Vault."

      # 6️⃣ Deploy backend (with frontend inside) to Azure App Service
      - name: Deploy app to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: "passion-lecture-romrom"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: "code/backend"
